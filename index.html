<!DOCTYPE html>
<html lang="kn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Challenge - GHPS Dasaravadi</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root { --primary: #1a2a6c; --gold: #c5a059; --accent: #b21f1f; }
        
        /* Mobile Best View Optimization */
        body { 
            font-family: 'Montserrat', sans-serif; 
            background: #f0f2f5; 
            margin: 0; 
            padding: 10px; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        .container { max-width: 800px; margin: auto; }
        .hidden { display: none !important; }
        
        .header { 
            background: linear-gradient(135deg, var(--primary), var(--accent)); 
            color: white; 
            text-align: center; 
            padding: 25px 15px; 
            border-radius: 15px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
        }
        
        .rainbow-school-name { 
            font-family: 'Cinzel', serif; 
            font-size: 20px; 
            font-weight: bold; 
            margin-bottom: 8px; 
            display: block; 
            background: linear-gradient(to right, #ff2400, #e81d1d, #e8b71d, #1de840, #1ddde8, #2b1de8, #dd1de8, #ff2400); 
            background-size: 200% auto; 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            animation: rainbow_move 3s linear infinite; 
            cursor: pointer; 
            user-select: none;
        }

        @keyframes rainbow_move { to { background-position: 200% center; } }
        
        #statusBanner { padding: 10px; border-radius: 8px; margin-top: 12px; font-weight: bold; font-size: 13px; text-align: center; }
        .status-upcoming { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .status-live { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; animation: pulse 2s infinite; }
        .status-closed { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); margin-top: 15px; border-top: 5px solid var(--gold); }
        
        /* Large touch targets for inputs */
        input, select { 
            width: 100%; 
            padding: 14px; 
            margin: 8px 0 15px 0; 
            border: 2px solid #eee; 
            border-radius: 10px; 
            box-sizing: border-box; 
            font-size: 16px; /* Prevents auto-zoom on mobile */
            outline: none; 
        }
        
        #sName, #pName { text-transform: uppercase; }

        button { padding: 16px; font-size: 16px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.3s; margin-top: 10px; width: 100%; }
        .btn-main { background: var(--primary); color: white; }
        .btn-main:disabled { background: #ccc; cursor: not-allowed; }
        
        /* Question Layout for Mobile */
        .question-box { margin-bottom: 25px; padding: 18px; border-radius: 15px; background: #fff; border: 1px solid #eaeaea; }
        .question-text { font-size: 18px; display: block; margin-bottom: 15px; color: #333; }
        
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        
        .option-card { 
            background: #f8f9fa; 
            border: 2px solid #eaeaea; 
            padding: 16px; 
            border-radius: 12px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            font-size: 16px;
            font-weight: 500;
        }
        
        .option-card input[type="radio"] { 
            width: 22px; 
            height: 22px; 
            margin-right: 12px; 
            accent-color: var(--primary);
        }

        #timer-sticky { 
            position: sticky; 
            top: 0; 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(5px);
            padding: 12px; 
            text-align: center; 
            font-size: 20px; 
            font-weight: 800; 
            color: #b21f1f; 
            z-index: 100; 
            border-bottom: 3px solid var(--gold); 
        }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
        th, td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }

        @media (min-width: 600px) {
            .options-grid { grid-template-columns: 1fr 1fr; }
            .rainbow-school-name { font-size: 24px; }
            .header { padding: 35px 20px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div id="studentPage">
        <div class="header">
            <span class="rainbow-school-name" id="secretTrigger">‡≤∏‡≤∞‡≤ï‡≤æ‡≤∞‡≤ø ‡≤π‡≤ø‡≤∞‡≤ø‡≤Ø ‡≤™‡≥ç‡≤∞‡≤æ‡≤•‡≤Æ‡≤ø‡≤ï ‡≤∂‡≤æ‡≤≤‡≥Ü, ‡≤¶‡≤æ‡≤∏‡≤∞‡≤µ‡≤æ‡≤°‡≤ø</span>
            <h1 style="margin: 5px 0; font-size: 20px;">üß† ‡≤Æ‡≤æ‡≤®‡≤∏‡≤ø‡≤ï ‡≤ó‡≤£‡≤ø‡≤§ ‡≤∏‡≥ç‡≤™‡≤∞‡≥ç‡≤ß‡≥Ü</h1>
            <div id="statusBanner" class="status-upcoming">‡≤≤‡≥ã‡≤°‡≥ç ‡≤Ü‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü...</div>
        </div>
        
        <div class="card">
            <label>‡≤µ‡≤ø‡≤¶‡≥ç‡≤Ø‡≤æ‡≤∞‡≥ç‡≤•‡≤ø‡≤Ø ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å (Student Name):</label>
            <input type="text" id="sName" placeholder="ENTER FULL NAME" oninput="this.value = this.value.toUpperCase()">
            <label>‡≤§‡≤Ç‡≤¶‡≥Ü‡≤Ø ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å (Father's Name):</label>
            <input type="text" id="pName" placeholder="ENTER FATHER'S NAME" oninput="this.value = this.value.toUpperCase()">
            <label>‡≤§‡≤∞‡≤ó‡≤§‡≤ø (Class):</label>
            <select id="studentClass">
                <option value="">-- Select Class --</option>
                <option value="5">5‡≤®‡≥á ‡≤§‡≤∞‡≤ó‡≤§‡≤ø</option><option value="6">6‡≤®‡≥á ‡≤§‡≤∞‡≤ó‡≤§‡≤ø</option><option value="7">7‡≤®‡≥á ‡≤§‡≤∞‡≤ó‡≤§‡≤ø</option><option value="8">8‡≤®‡≥á ‡≤§‡≤∞‡≤ó‡≤§‡≤ø</option>
            </select>
            <label>‡≤∞‡≥ã‡≤≤‡≥ç ‡≤®‡≤Ç‡≤¨‡≤∞‡≥ç (Roll Number):</label>
            <input type="number" id="studentrollnumber" placeholder="Enter Roll No." 
       oninput="this.value = this.value.replace(/[^0-9]/g, ''); checkRollNumber()">

            <button class="btn-main" id="startBtn" onclick="startQuiz()" disabled>‡≤ï‡≥ç‡≤µ‡≤ø‡≤ú‡≥ç ‡≤™‡≥ç‡≤∞‡≤æ‡≤∞‡≤Ç‡≤≠‡≤ø‡≤∏‡≤ø (Start Quiz) ‚ûî</button>
        </div>
    </div>

    <div id="quizPage" class="hidden">
        <div id="timer-sticky">‚è± <span id="timer">300</span> ‡≤∏‡≥Ü‡≤ï‡≥Ü‡≤Ç‡≤°‡≥Å‡≤ó‡≤≥‡≥Å</div>
        <div id="questionsContainer"></div>
        <button class="btn-main" style="background:green; margin-bottom:50px;" onclick="submitQuiz()">‡≤∏‡≤≤‡≥ç‡≤≤‡≤ø‡≤∏‡≤ø (Finish Quiz)</button>
    </div>
<!-- THANK YOU PAGE -->
<div id="thankYouPage" class="hidden">
  <div class="header">
    <div class="rainbow">‡≤∏‡≤∞‡≤ï‡≤æ‡≤∞‡≤ø ‡≤π‡≤ø‡≤∞‡≤ø‡≤Ø ‡≤™‡≥ç‡≤∞‡≤æ‡≤•‡≤Æ‡≤ø‡≤ï ‡≤∂‡≤æ‡≤≤‡≥Ü, ‡≤¶‡≤æ‡≤∏‡≤∞‡≤µ‡≤æ‡≤°‡≤ø</div>
    <h2>üôè ‡≤ß‡≤®‡≥ç‡≤Ø‡≤µ‡≤æ‡≤¶‡≤ó‡≤≥‡≥Å üôè</h2>
  </div>

  <div class="card" style="text-align:center">
    <h3 style="color:green">Quiz Submitted Successfully</h3>
    <p id="finalName"></p>
    <p style="color:red;font-weight:bold">‡≤ï‡≥á‡≤µ‡≤≤ ‡≤í‡≤Ç‡≤¶‡≥Å ‡≤™‡≥ç‡≤∞‡≤Ø‡≤§‡≥ç‡≤®‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Ö‡≤®‡≥Å‡≤Æ‡≤§‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü</p>

    <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjTs7bWODsf6kahAsLK9E_U3a-hbACRye0_PQ1gQTejHbY72xVbW4LtZOub63G9Fx2ABvfY7MUONnkr9WJrG7NVMlqXwGEPgqqnbnf2x95iQFs2Ix0lJKvc2ggoJPshCxZqdTDPgfAPsEeTI9arQZPL1cmSl4vnG0v3e4eWocE3OMLesDxfjZ0HayaZLCID/s1600/220028.gif"
         width="280" height="130" loading="lazy">
  </div>
</div>

</div>
    <div id="scorePage" class="hidden">
        <div class="header"><span class="rainbow-school-name">‡≤∏‡≤∞‡≤ï‡≤æ‡≤∞‡≤ø ‡≤π‡≤ø‡≤∞‡≤ø‡≤Ø ‡≤™‡≥ç‡≤∞‡≤æ‡≤•‡≤Æ‡≤ø‡≤ï ‡≤∂‡≤æ‡≤≤‡≥Ü, ‡≤¶‡≤æ‡≤∏‡≤∞‡≤µ‡≤æ‡≤°‡≤ø</span><h1>üìä Admin Panel</h1></div>
        <div class="card">
            <h3>üïí Competition Schedule</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div><label>Start:</label><input type="datetime-local" id="schedStart"></div>
                <div><label>End:</label><input type="datetime-local" id="schedEnd"></div>
            </div>
            <button onclick="saveSchedule()" class="btn-main">Update Schedule</button>
            <button onclick="resetSchedule()" style="background:#666; color:white;">Reset Schedule</button>
        </div>
        <div class="card">
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button onclick="downloadWholeResultsPDF()" style="background:#e74c3c; color:white; flex:1; font-size:12px;">PDF</button>
                <button onclick="exportCSV()" style="background:#1D6F42; color:white; flex:1; font-size:12px;">Excel</button>
                <button onclick="clearAllData()" style="background:#333; color:white; flex:1; font-size:12px;">Wipe All</button>
            </div>
            <div style="overflow-x: auto;">
                <table>
                    <thead><tr><th>Rank</th><th>Student</th><th>Class</th><th>Score</th><th>Action</th></tr></thead>
                    <tbody id="leaderboardBody"></tbody>
                </table>
            </div>
            <button onclick="location.reload()" style="background:#eee; color:#333; margin-top: 20px;">Exit Admin</button>
        </div>
    </div>

    <div id="adminModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:1000;">
        <div style="background:white; padding:30px; border-radius:15px; width:300px; text-align:center;">
            <h3>Admin Access</h3>
            <input type="password" id="adminPass" placeholder="Enter Password">
            <button class="btn-main" onclick="verifyAdmin()">Login</button>
            <button onclick="toggleAdminModal()" style="background:none; color:gray;">Close</button>
        </div>
    </div>

<script>
    // 1. FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyCDg2lvJAsZvqP1YfalJj6jpA7qTBn5qRM",
        authDomain: "mathsquizcompetitionsjs.firebaseapp.com",
        projectId: "mathsquizcompetitionsjs",
        storageBucket: "mathsquizcompetitionsjs.firebasestorage.app",
        messagingSenderId: "697659887210",
        appId: "1:697659887210:web:21d4f2a4244093466b0413"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    // ‚úÖ Prevent multiple attempts by checking roll number
async function checkRollNumber() {
    const roll = document.getElementById('studentrollnumber').value.trim();
    const cls = document.getElementById('studentClass').value;
    const startBtn = document.getElementById('startBtn');

    if(!roll || !cls) { 
        startBtn.disabled = true; 
        return; 
    }

    const snap = await db.collection("mathResults")
                         .where("roll", "==", roll)
                         .where("class", "==", cls)
                         .get();

    startBtn.disabled = !snap.empty ? true : false; // disable if already attempted
}

    
    async function startQuiz() {
    const name = document.getElementById('sName').value.trim();
    const pName = document.getElementById('pName').value.trim();
    const cls = document.getElementById('studentClass').value;
    const roll = document.getElementById('studentrollnumber').value.trim();
    
    if(!name || !pName || !cls || !roll) return alert("Fill all details!");

    // ‚úÖ DEVICE-INDEPENDENT BLOCK
    const snap = await db.collection("mathResults")
                         .where("roll", "==", roll)
                         .where("class", "==", cls)
                         .get();
    if(!snap.empty){
        alert("‚ö† Already Attempted! You cannot start the quiz again.");
        return; // stop quiz start
    }

    // ‚Ä¶rest of startQuiz() continues here
}

    
    

    // 2. SECRET DOOR LOGIC
    let clicks = 0;
    let clickTimeout;
    document.getElementById('secretTrigger').onclick = function() {
        clicks++;
        clearTimeout(clickTimeout);
        if(clicks === 5) { clicks = 0; toggleAdminModal(); }
        clickTimeout = setTimeout(() => { clicks = 0; }, 2500);
    };

    function toggleAdminModal() { document.getElementById('adminModal').classList.toggle('hidden'); }

    function verifyAdmin() {
        if(document.getElementById('adminPass').value === "Sairam@123") {
            toggleAdminModal();
            document.getElementById('studentPage').classList.add('hidden');
            document.getElementById('scorePage').classList.remove('hidden');
            loadLeaderboard();
            loadScheduleInputs();
        } else { alert("Wrong Password!"); }
    }

    // 3. QUIZ CONTENT
    const questions = [
    { q: "36 + 49 = ?", options: ["75", "85", "95", "80"], a: "85" },
    { q: "90 - 48 = ?", options: ["42", "52", "38", "48"], a: "42" },
    { q: "14 √ó 6 = ?", options: ["72", "84", "96", "64"], a: "84" },
    { q: "72 √∑ 8 = ?", options: ["7", "8", "9", "6"], a: "9" },
    { q: "18 √ó 5 = ?", options: ["80", "85", "90", "95"], a: "90" },

    { q: "150 + 275 = ?", options: ["425", "450", "400", "475"], a: "425" },
    { q: "600 - 248 = ?", options: ["352", "362", "348", "350"], a: "352" },
    { q: "200 √ó 8 = ?", options: ["1800", "1614", "1260", "1600"], a: "1600" },
    { q: "144 √∑ 12 = ?", options: ["10", "11", "12", "13"], a: "12" },
    { q: "75 + 25 = ?", options: ["90", "95", "100", "105"], a: "100" },

    { q: "7 √ó 9 = ?", options: ["56", "63", "72", "69"], a: "63" },
    { q: "200 √∑ 4 = ?", options: ["40", "45", "50", "60"], a: "50" },
    { q: "11 ‡≤∞ ‡≤µ‡≤∞‡≥ç‡≤ó ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å ?", options: ["111", "121", "131", "141"], a: "121" },
    { q: "36 ‡≤∞ ‡≤µ‡≤∞‡≥ç‡≤ó‡≤Æ‡≥Ç‡≤≤ ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å ?", options: ["4", "5", "6", "7"], a: "6" },
    { q: "625 √∑ 25 = ?", options: ["20", "25", "30", "35"], a: "25" },

    { q: "400 + 600 = ?", options: ["900", "1000", "1100", "1200"], a: "1000" },
    { q: "1000 - 375 = ?", options: ["625", "650", "600", "675"], a: "625" },
    { q: "30 √ó 4 = ?", options: ["100", "110", "120", "130"], a: "120" },
    { q: "81 √∑ 3 = ?", options: ["24", "25", "26", "27"], a: "27" },
    { q: "20 ‡≤∞ ‡≤µ‡≤∞‡≥ç‡≤ó ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å ?", options: ["200", "300", "400", "500"], a: "400" },

    { q: "‡≤í‡≤Ç‡≤¶‡≥Å ‡≤µ‡≤æ‡≤∞‡≤¶‡≤≤‡≥ç‡≤≤‡≤ø ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å ‡≤¶‡≤ø‡≤®?", options: ["5", "6", "7", "8"], a: "7" },
    { q: "‡≤í‡≤Ç‡≤¶‡≥Å ‡≤∞‡≥Ç‡≤™‡≤æ‡≤Ø‡≤ø‡≤Ø‡≤≤‡≥ç‡≤≤‡≤ø ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å ‡≤™‡≥à‡≤∏‡≥Ü?", options: ["10", "50", "100", "1000"], a: "100" },
    { q: "50 ‡≤∞ 20% ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å?", options: ["5", "10", "15", "20"], a: "10" },
    { q: "‡≤Ö‡≤§‡≤ø‡≤ö‡≤ø‡≤ï‡≥ç‡≤ï ‡≤Ö‡≤µ‡≤ø‡≤≠‡≤æ‡≤ú‡≥ç‡≤Ø ‡≤∏‡≤Ç‡≤ñ‡≥ç‡≤Ø‡≥Ü?", options: ["0", "1", "2", "3"], a: "2" },
    { q: "‡≤í‡≤Ç‡≤¶‡≥Å ‡≤µ‡≤∞‡≥ç‡≤∑‡≤¶‡≤≤‡≥ç‡≤≤‡≤ø ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å ‡≤§‡≤ø‡≤Ç‡≤ó‡≤≥‡≥Å?", options: ["10", "11", "12", "13"], a: "12" },

    { q: "1 ‡≤ï‡≤ø‡≤Æ‡≥Ä = ? ‡≤Æ‡≥Ä‡≤ü‡≤∞‡≥ç", options: ["100", "500", "1000", "1500"], a: "1000" },
    { q: "‡≤í‡≤Ç‡≤¶‡≥Å ‡≤§‡≥ç‡≤∞‡≤ø‡≤≠‡≥Å‡≤ú‡≤ï‡≥ç‡≤ï‡≥Ü ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å ‡≤¨‡≤¶‡≤ø‡≤ó‡≤≥‡≥Å?", options: ["2", "3", "4", "5"], a: "3" },
    { q: "10 √ó 10 = ?", options: ["10", "50", "100", "1000"], a: "100" },
    { q: "‡≤Ö‡≤∞‡≥ç‡≤ß ‡≤°‡≤ú‡≤®‡≥ç ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å?", options: ["4", "5", "6", "8"], a: "6" },
    { q: "60 ‡≤®‡≤ø‡≤Æ‡≤ø‡≤∑ = ? ‡≤ó‡≤Ç‡≤ü‡≥Ü", options: ["¬Ω", "1", "2", "3"], a: "1" }
];

    // 4. MAIN FUNCTIONS
    async function updateStatus() {
        const doc = await db.collection("settings").doc("quizTime").get();
        const banner = document.getElementById('statusBanner');
        const startBtn = document.getElementById('startBtn');
        if(!doc.exists || !doc.data().start) {
            banner.className="status-upcoming"; banner.innerText = "‡≤ï‡≥ç‡≤µ‡≤ø‡≤ú‡≥ç ‡≤á‡≤®‡≥ç‡≤®‡≥Ç ‡≤™‡≥ç‡≤∞‡≤æ‡≤∞‡≤Ç‡≤≠‡≤µ‡≤æ‡≤ó‡≤ø‡≤≤‡≥ç‡≤≤...!";
            startBtn.disabled = true; return;
        }
        const now = new Date(), start = new Date(doc.data().start), end = new Date(doc.data().end);
        if(now < start) { banner.className="status-upcoming"; banner.innerText = "Upcoming..."; startBtn.disabled = true; }
        else if(now <= end) { banner.className = "status-live"; banner.innerText = "‚óè LIVE: Quiz is Open!"; startBtn.disabled = false; }
        else { banner.className = "status-closed"; banner.innerText = "Closed!"; startBtn.disabled = true; }
    }
    setInterval(updateStatus, 5000); updateStatus();

    async function startQuiz() {
    const name = document.getElementById('sName').value.trim();
    const pName = document.getElementById('pName').value.trim();
    const cls = document.getElementById('studentClass').value;
    const roll = document.getElementById('studentrollnumber').value.trim();
    
    if(!name || !pName || !cls || !roll) return alert("Fill all details!");
    
    // ‚úÖ DEVICE-INDEPENDENT BLOCK
    const snap = await db.collection("mathResults")
                         .where("roll", "==", roll)
                         .where("class", "==", cls)
                         .get();
    if(!snap.empty){
        alert("‚ö† Already Attempted! You cannot start the quiz again.");
        return; // stop quiz start
    }

        document.getElementById('questionsContainer').innerHTML = questions.map((item, i) => `
            <div class="card question-box">
                <b class="question-text">${i+1}. ${item.q}</b>
                <div class="options-grid">${item.options.map(opt => `
                    <label class="option-card"><input type="radio" name="q${i}" value="${opt}"> ${opt}</label>
                `).join('')}</div>
            </div>`).join('');
        document.getElementById('studentPage').classList.add('hidden');
        document.getElementById('quizPage').classList.remove('hidden');
        window.scrollTo(0,0);
        
        let timer = 300;
        let t = setInterval(() => {
            timer--; document.getElementById('timer').innerText = timer;
            if(timer <= 0) { clearInterval(t); submitQuiz(); }
        }, 1000);
    }

    
async function submitQuiz() {
    let score = 0;

    questions.forEach((item, i) => {
        if (
            document.querySelector(`input[name="q${i}"]:checked`)?.value === item.a
        ) {
            score++;
        }
    });

    // Save to Firebase
    await db.collection("mathResults").add({
        name: document.getElementById('sName').value.toUpperCase(),
        father: document.getElementById('pName').value.toUpperCase(),
        class: document.getElementById('studentClass').value,
        roll: document.getElementById('studentrollnumber').value,
        score: score,
        timestamp: new Date()
    });

    // Show Thank You page
    document.getElementById('quizPage').classList.add('hidden');
    document.getElementById('thankYouPage').classList.remove('hidden');

    // Show student name (NO score)
    document.getElementById('finalName').innerText =
        "‡≤µ‡≤ø‡≤¶‡≥ç‡≤Ø‡≤æ‡≤∞‡≥ç‡≤•‡≤ø ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å: " + document.getElementById('sName').value;
}

    // 5. ADMIN UTILITIES
    async function loadLeaderboard() {
        const snap = await db.collection("mathResults").orderBy("score", "desc").get();
        let rank = 1;
        document.getElementById('leaderboardBody').innerHTML = snap.docs.map(doc => {
            const d = doc.data();
            return `<tr><td>#${rank++}</td><td>${d.name}</td><td>${d.class}th</td><td>${d.score}/30</td>
            <td><button onclick="deleteRecord('${doc.id}')" style="background:red;color:white;padding:5px;width:auto;font-size:10px;">Del</button></td></tr>`;
        }).join('');
    }

    async function deleteRecord(id) {
        if(confirm("Delete this student record?")) {
            await db.collection("mathResults").doc(id).delete();
            loadLeaderboard();
        }
    }

    async function saveSchedule() {
        const start = document.getElementById('schedStart').value;
        const end = document.getElementById('schedEnd').value;
        if(!start || !end) return alert("Set both times!");
        await db.collection("settings").doc("quizTime").set({ start, end });
        alert("Schedule Saved!"); updateStatus();
    }

    async function resetSchedule() {
        if(confirm("Reset schedule? This will lock the quiz for students.")) {
            await db.collection("settings").doc("quizTime").delete();
            document.getElementById('schedStart').value = "";
            document.getElementById('schedEnd').value = "";
            alert("Schedule Reset!"); updateStatus();
        }
    }

    async function clearAllData() {
        if(confirm("WARNING: Delete ALL results?")) {
            const snap = await db.collection("mathResults").get();
            const batch = db.batch();
            snap.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            alert("All results wiped!"); loadLeaderboard();
        }
    }

    function exportCSV() {
        let csv = "Rank,Name,Father,Class,Roll,Score\n";
        document.querySelectorAll("#leaderboardBody tr").forEach(row => {
            csv += Array.from(row.querySelectorAll("td")).slice(0,4).map(c => c.innerText.replace("#","")).join(",") + "\n";
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = window.URL.createObjectURL(blob); a.download = 'Quiz_Results.csv'; a.click();
    }

    async function loadScheduleInputs() {
        const doc = await db.collection("settings").doc("quizTime").get();
        if(doc.exists) {
            document.getElementById('schedStart').value = doc.data().start;
            document.getElementById('schedEnd').value = doc.data().end;
        }
    }

    async function downloadWholeResultsPDF() {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        const snap = await db.collection("mathResults").orderBy("score", "desc").get();
        const rows = snap.docs.map((d, i) => [i+1, d.data().name, d.data().father, d.data().class, d.data().roll, d.data().score + "/30"]);
        doc.text("Govt. Higher Primary School Dasarawadi, Maths Quiz Results 2025", 14, 15);
        doc.autoTable({ head: [['Rank', 'Name','Father', 'Class', 'Roll', 'Score']], body: rows, startY: 20 });
        doc.save("Results.pdf");
    }
</script>
</body>
</html>
