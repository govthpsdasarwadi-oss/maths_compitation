<!DOCTYPE html>
<html lang="kn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Challenge - GHPS Dasaravadi</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root { --primary: #1a2a6c; --gold: #c5a059; --accent: #b21f1f; }
        body { font-family: 'Montserrat', sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .container { max-width: 800px; margin: auto; }
        .hidden { display: none !important; }
        .header { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; text-align: center; padding: 35px 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        
        .rainbow-school-name { 
            font-family: 'Cinzel', serif; font-size: 24px; font-weight: bold; margin-bottom: 10px; 
            display: block; background: linear-gradient(to right, #ff2400, #e81d1d, #e8b71d, #1de840, #1ddde8, #2b1de8, #dd1de8, #ff2400); 
            background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            animation: rainbow_move 3s linear infinite; cursor: pointer; user-select: none;
        }

        @keyframes rainbow_move { to { background-position: 200% center; } }
        
        #statusBanner { padding: 12px; border-radius: 8px; margin-top: 15px; font-weight: bold; font-size: 14px; text-align: center; }
        .status-upcoming { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .status-live { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; animation: pulse 2s infinite; }
        .status-closed { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); margin-top: 20px; border-top: 5px solid var(--gold); }
        input, select { width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #eee; border-radius: 10px; box-sizing: border-box; font-size: 16px; outline: none; }
        #sName, #pName { text-transform: uppercase; }

        button { padding: 15px; font-size: 16px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.3s; margin-top: 10px; }
        .btn-main { background: var(--primary); color: white; width: 100%; }
        .btn-main:disabled { background: #ccc; cursor: not-allowed; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        .question-box { margin-bottom: 30px; padding: 15px; border-radius: 12px; background: #fff; }
        .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
        .option-card { background: #f8f9fa; border: 2px solid #eaeaea; padding: 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; }
        #timer-sticky { position: sticky; top: 0; background: #fff; padding: 15px; text-align: center; font-size: 22px; font-weight: 800; color: #b21f1f; z-index: 100; border-bottom: 3px solid var(--gold); }
    </style>
</head>
<body>

<div class="container">
    <div id="studentPage">
        <div class="header">
            <span class="rainbow-school-name" id="secretTrigger">‡≤∏‡≤∞‡≤ï‡≤æ‡≤∞‡≤ø ‡≤π‡≤ø‡≤∞‡≤ø‡≤Ø ‡≤™‡≥ç‡≤∞‡≤æ‡≤•‡≤Æ‡≤ø‡≤ï ‡≤∂‡≤æ‡≤≤‡≥Ü, ‡≤¶‡≤æ‡≤∏‡≤∞‡≤µ‡≤æ‡≤°‡≤ø</span>
            <h1 style="margin: 5px 0; font-size: 22px;">üß† ‡≤Æ‡≤æ‡≤®‡≤∏‡≤ø‡≤ï ‡≤ó‡≤£‡≤ø‡≤§ ‡≤∏‡≥ç‡≤™‡≤∞‡≥ç‡≤ß‡≥Ü</h1>
            <div id="statusBanner" class="status-upcoming">‡≤≤‡≥ã‡≤°‡≥ç ‡≤Ü‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü...</div>
        </div>
        
        <div class="card">
            <label>‡≤µ‡≤ø‡≤¶‡≥ç‡≤Ø‡≤æ‡≤∞‡≥ç‡≤•‡≤ø‡≤Ø ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å (Student Name):</label>
            <input type="text" id="sName" placeholder="ENTER FULL NAME" oninput="this.value = this.value.toUpperCase()">
            <label>‡≤§‡≤Ç‡≤¶‡≥Ü‡≤Ø ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å (Father's Name):</label>
            <input type="text" id="pName" placeholder="ENTER FATHER'S NAME" oninput="this.value = this.value.toUpperCase()">
            <label>‡≤§‡≤∞‡≤ó‡≤§‡≤ø (Class):</label>
            <select id="studentClass">
                <option value="">-- Select Class --</option>
                <option value="5">5‡≤®‡≥á ‡≤§‡≤∞‡≤ó‡≤§‡≤ø</option><option value="6">6‡≤®‡≥á ‡≤§‡≤∞‡≤ó‡≤§‡≤ø</option><option value="7">7‡≤®‡≥á ‡≤§‡≤∞‡≤ó‡≤§‡≤ø</option><option value="8">8‡≤®‡≥á ‡≤§‡≤∞‡≤ó‡≤§‡≤ø</option>
            </select>
            <label>‡≤∞‡≥ã‡≤≤‡≥ç ‡≤®‡≤Ç‡≤¨‡≤∞‡≥ç (Roll Number):</label>
            <input type="number" id="studentrollnumber" placeholder="Enter Roll No." oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            <button class="btn-main" id="startBtn" onclick="startQuiz()" disabled>‡≤ï‡≥ç‡≤µ‡≤ø‡≤ú‡≥ç ‡≤™‡≥ç‡≤∞‡≤æ‡≤∞‡≤Ç‡≤≠‡≤ø‡≤∏‡≤ø (Start Quiz) ‚ûî</button>
        </div>
    </div>

    <div id="quizPage" class="hidden">
        <div id="timer-sticky">‚è± <span id="timer">120</span> ‡≤∏‡≥Ü‡≤ï‡≥Ü‡≤Ç‡≤°‡≥Å‡≤ó‡≤≥‡≥Å</div>
        <div id="questionsContainer"></div>
        <button class="btn-main" style="background:green; margin-bottom:50px;" onclick="submitQuiz()">‡≤∏‡≤≤‡≥ç‡≤≤‡≤ø‡≤∏‡≤ø (Finish Quiz)</button>
    </div>

    <div id="scorePage" class="hidden">
        <div class="header"><span class="rainbow-school-name">‡≤∏‡≤∞‡≤ï‡≤æ‡≤∞‡≤ø ‡≤π‡≤ø‡≤∞‡≤ø‡≤Ø ‡≤™‡≥ç‡≤∞‡≤æ‡≤•‡≤Æ‡≤ø‡≤ï ‡≤∂‡≤æ‡≤≤‡≥Ü, ‡≤¶‡≤æ‡≤∏‡≤∞‡≤µ‡≤æ‡≤°‡≤ø</span><h1>üìä Admin Panel</h1></div>
        <div class="card">
            <h3>üïí Competition Schedule</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div><label>Start:</label><input type="datetime-local" id="schedStart"></div>
                <div><label>End:</label><input type="datetime-local" id="schedEnd"></div>
            </div>
            <button onclick="saveSchedule()" class="btn-main">Update Schedule</button>
            <button onclick="resetSchedule()" style="background:#666; color:white; width:100%;">Reset Schedule (Stop Quiz)</button>
        </div>
        <div class="card">
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="downloadWholeResultsPDF()" style="background:#e74c3c; color:white; flex:1;">Download PDF</button>
                <button onclick="exportCSV()" style="background:#1D6F42; color:white; flex:1;">Export Excel</button>
                <button onclick="clearAllData()" style="background:#333; color:white; flex:1;">Wipe All Data</button>
            </div>
            <div style="overflow-x: auto;">
                <table>
                    <thead><tr><th>Rank</th><th>Student</th><th>Father</th><th>Class</th><th>Roll</th><th>Score</th><th>Action</th></tr></thead>
                    <tbody id="leaderboardBody"></tbody>
                </table>
            </div>
            <button onclick="location.reload()" style="background:#eee; color:#333; width: 100%; margin-top: 20px;">Exit Admin</button>
        </div>
    </div>

    <div id="adminModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:1000;">
        <div style="background:white; padding:30px; border-radius:15px; width:300px; text-align:center;">
            <h3>Admin Access</h3>
            <input type="password" id="adminPass" placeholder="Enter Password">
            <button class="btn-main" onclick="verifyAdmin()">Login</button>
            <button onclick="toggleAdminModal()" style="background:none; color:gray; width:100%;">Close</button>
        </div>
    </div>
</div>

<script>
    // 1. FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyCDg2lvJAsZvqP1YfalJj6jpA7qTBn5qRM",
        authDomain: "mathsquizcompetitionsjs.firebaseapp.com",
        projectId: "mathsquizcompetitionsjs",
        storageBucket: "mathsquizcompetitionsjs.firebasestorage.app",
        messagingSenderId: "697659887210",
        appId: "1:697659887210:web:21d4f2a4244093466b0413"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2. SECRET DOOR LOGIC
    let clicks = 0;
    let clickTimeout;
    document.getElementById('secretTrigger').onclick = function() {
        clicks++;
        clearTimeout(clickTimeout);
        if(clicks === 5) { clicks = 0; toggleAdminModal(); }
        clickTimeout = setTimeout(() => { clicks = 0; }, 2500);
    };

    function toggleAdminModal() { document.getElementById('adminModal').classList.toggle('hidden'); }

    function verifyAdmin() {
        if(document.getElementById('adminPass').value === "Sairam@123") {
            toggleAdminModal();
            document.getElementById('studentPage').classList.add('hidden');
            document.getElementById('scorePage').classList.remove('hidden');
            loadLeaderboard();
            loadScheduleInputs();
        } else { alert("Wrong Password!"); }
    }

    // 3. QUIZ CONTENT
    const questions = [
        { q: "45 + 32 = ?", options: ["77", "87", "75", "80"], a: "77" },
        { q: "100 - 37 = ?", options: ["63", "73", "53", "67"], a: "63" },
        { q: "12 √ó 5 = ?", options: ["50", "60", "70", "55"], a: "60" },
        { q: "81 √∑ 9 = ?", options: ["7", "8", "9", "10"], a: "9" },
        { q: "25 √ó 4 = ?", options: ["100", "125", "75", "150"], a: "100" },
        { q: "120 + 85 = ?", options: ["195", "205", "215", "200"], a: "205" },
        { q: "250 - 125 = ?", options: ["100", "150", "125", "115"], a: "125" },
        { q: "15 √ó 6 = ?", options: ["80", "90", "100", "75"], a: "90" },
        { q: "120 √∑ 10 = ?", options: ["10", "12", "15", "20"], a: "12" },
        { q: "99 + 11 = ?", options: ["100", "110", "111", "109"], a: "110" },
        { q: "84 - 29 = ?", options: ["55", "65", "45", "59"], a: "55" },
        { q: "9 √ó 13 = ?", options: ["107", "117", "127", "113"], a: "117" },
        { q: "100 √∑ 4 = ?", options: ["20", "25", "30", "50"], a: "25" },
        { q: "12^2 = ?", options: ["124", "144", "134", "154"], a: "144" },
        { q: "sqrt 25 = ?", options: ["5", "10", "15", "25"], a: "5" },
        { q: "550 + 450 = ?", options: ["900", "1000", "1100", "950"], a: "1000" },
        { q: "500 - 199 = ?", options: ["301", "311", "299", "300"], a: "301" },
        { q: "50 √ó 20 = ?", options: ["500", "1000", "2000", "1500"], a: "1000" },
        { q: "64 √∑ 8 = ?", options: ["6", "7", "8", "9"], a: "8" },
        { q: "15^2 = ?", options: ["225", "215", "205", "250"], a: "225" },
        { q: "18 + 24 + 6 = ?", options: ["42", "48", "50", "54"], a: "48" },
        { q: "1000 - 450 = ?", options: ["550", "650", "450", "500"], a: "550" },
        { q: "500 √∑ 5 = ?", options: ["50", "100", "150", "200"], a: "100" },
        { q: "sqrt 81 = ?", options: ["7", "8", "9", "11"], a: "9" },
        { q: "1 ‡≤ï‡≥Ü‡≤ú‡≤ø‡≤Ø‡≤≤‡≥ç‡≤≤‡≤ø ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å ‡≤ó‡≥ç‡≤∞‡≤æ‡≤Ç?", options: ["100", "500", "1000", "100"], a: "1000" },
        { q: "‡≤í‡≤Ç‡≤¶‡≥Å ‡≤ó‡≤Ç‡≤ü‡≥Ü‡≤ó‡≥Ü ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å ‡≤®‡≤ø‡≤Æ‡≤ø‡≤∑?", options: ["30", "60", "100", "120"], a: "60" },
        { q: "20 ‡≤∞ 10% ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å?", options: ["1", "2", "5", "10"], a: "2" },
        { q: "‡≤í‡≤Ç‡≤¶‡≥Å ‡≤°‡≤ú‡≤®‡≥ç ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å?", options: ["10", "12", "14", "24"], a: "12" },
        { q: "7 ‡≤∞ ‡≤®‡≤Ç‡≤§‡≤∞‡≤¶ ‡≤Ö‡≤µ‡≤ø‡≤≠‡≤æ‡≤ú‡≥ç‡≤Ø ‡≤∏‡≤Ç‡≤ñ‡≥ç‡≤Ø‡≥Ü?", options: ["8", "9", "10", "11"], a: "11" },
        { q: "100 ‡≤∞ ‡≤Ö‡≤∞‡≥ç‡≤ß?", options: ["25", "40", "50", "60"], a: "50" }
    ];

    // 4. MAIN FUNCTIONS
    async function updateStatus() {
        const doc = await db.collection("settings").doc("quizTime").get();
        const banner = document.getElementById('statusBanner');
        const startBtn = document.getElementById('startBtn');
        if(!doc.exists || !doc.data().start) {
            banner.className="status-upcoming"; banner.innerText = "‡≤ï‡≥ç‡≤µ‡≤ø‡≤ú‡≥ç ‡≤á‡≤®‡≥ç‡≤®‡≥Ç ‡≤™‡≥ç‡≤∞‡≤æ‡≤∞‡≤Ç‡≤≠‡≤µ‡≤æ‡≤ó‡≤ø‡≤≤‡≥ç‡≤≤...!";
            startBtn.disabled = true; return;
        }
        const now = new Date(), start = new Date(doc.data().start), end = new Date(doc.data().end);
        if(now < start) { banner.className="status-upcoming"; banner.innerText = "Upcoming..."; startBtn.disabled = true; }
        else if(now <= end) { banner.className = "status-live"; banner.innerText = "‚óè LIVE: Quiz is Open!"; startBtn.disabled = false; }
        else { banner.className = "status-closed"; banner.innerText = "Closed!"; startBtn.disabled = true; }
    }
    setInterval(updateStatus, 5000); updateStatus();

    async function startQuiz() {
        const name = document.getElementById('sName').value.trim();
        const pName = document.getElementById('pName').value.trim();
        const cls = document.getElementById('studentClass').value;
        const roll = document.getElementById('studentrollnumber').value.trim();
        if(!name || !pName || !cls || !roll) return alert("Fill all details!");

        document.getElementById('questionsContainer').innerHTML = questions.map((item, i) => `
            <div class="card question-box">
                <b>${i+1}. ${item.q}</b>
                <div class="options-grid">${item.options.map(opt => `
                    <label class="option-card"><input type="radio" name="q${i}" value="${opt}"> ${opt}</label>
                `).join('')}</div>
            </div>`).join('');
        document.getElementById('studentPage').classList.add('hidden');
        document.getElementById('quizPage').classList.remove('hidden');
        
        let timer = 120;
        let t = setInterval(() => {
            timer--; document.getElementById('timer').innerText = timer;
            if(timer <= 0) { clearInterval(t); submitQuiz(); }
        }, 1000);
    }

    async function submitQuiz() {
        let score = 0;
        questions.forEach((item, i) => {
            if(document.querySelector(`input[name="q${i}"]:checked`)?.value === item.a) score++;
        });
        await db.collection("mathResults").add({
            name: document.getElementById('sName').value.toUpperCase(),
            father: document.getElementById('pName').value.toUpperCase(),
            class: document.getElementById('studentClass').value,
            roll: document.getElementById('studentrollnumber').value,
            score: score, timestamp: new Date()
        });
        alert("‡≤∏‡≤≤‡≥ç‡≤≤‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü!"); location.reload();
    }

    // 5. ADMIN UTILITIES
    async function loadLeaderboard() {
        const snap = await db.collection("mathResults").orderBy("score", "desc").get();
        let rank = 1;
        document.getElementById('leaderboardBody').innerHTML = snap.docs.map(doc => {
            const d = doc.data();
            return `<tr><td>#${rank++}</td><td>${d.name}</td><td>${d.father}</td><td>${d.class}th</td><td>${d.roll}</td><td>${d.score}/30</td>
            <td><button onclick="deleteRecord('${doc.id}')" style="background:red;color:white;padding:5px;border-radius:5px;">Del</button></td></tr>`;
        }).join('');
    }

    async function deleteRecord(id) {
        if(confirm("Delete this student record?")) {
            await db.collection("mathResults").doc(id).delete();
            loadLeaderboard();
        }
    }

    async function saveSchedule() {
        const start = document.getElementById('schedStart').value;
        const end = document.getElementById('schedEnd').value;
        if(!start || !end) return alert("Set both times!");
        await db.collection("settings").doc("quizTime").set({ start, end });
        alert("Schedule Saved!"); updateStatus();
    }

    async function resetSchedule() {
        if(confirm("Reset schedule? This will lock the quiz for students.")) {
            await db.collection("settings").doc("quizTime").delete();
            document.getElementById('schedStart').value = "";
            document.getElementById('schedEnd').value = "";
            alert("Schedule Reset!"); updateStatus();
        }
    }

    async function clearAllData() {
        if(confirm("WARNING: Delete ALL results?")) {
            const snap = await db.collection("mathResults").get();
            const batch = db.batch();
            snap.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            alert("All results wiped!"); loadLeaderboard();
        }
    }

    function exportCSV() {
        let csv = "Rank,Name,Father,Class,Roll,Score\n";
        document.querySelectorAll("#leaderboardBody tr").forEach(row => {
            csv += Array.from(row.querySelectorAll("td")).slice(0,6).map(c => c.innerText.replace("#","")).join(",") + "\n";
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = window.URL.createObjectURL(blob); a.download = 'Quiz_Results.csv'; a.click();
    }

    async function loadScheduleInputs() {
        const doc = await db.collection("settings").doc("quizTime").get();
        if(doc.exists) {
            document.getElementById('schedStart').value = doc.data().start;
            document.getElementById('schedEnd').value = doc.data().end;
        }
    }

    async function downloadWholeResultsPDF() {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        const snap = await db.collection("mathResults").orderBy("score", "desc").get();
        const rows = snap.docs.map((d, i) => [i+1, d.data().name, d.data().father, d.data().class, d.data().roll, d.data().score + "/30"]);
        doc.text("Govt. Higher Primary School Dasarawadi, Maths Quiz Results 2025", 14, 15);
        doc.autoTable({ head: [['Rank', 'Name','Father', 'Class', 'Roll', 'Score']], body: rows, startY: 20 });
        doc.save("Results.pdf");
    }
</script>
</body>
</html>
