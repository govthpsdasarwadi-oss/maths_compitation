<!DOCTYPE html>
<html lang="kn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Challenge - GHPS Dasaravadi</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root { --primary: #1a2a6c; --gold: #c5a059; --accent: #b21f1f; }
        body { font-family: 'Montserrat', sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .container { max-width: 800px; margin: auto; }
        .hidden { display: none !important; }

        .header { 
            background: linear-gradient(135deg, var(--primary), var(--accent)); 
            color: white; text-align: center; padding: 35px 20px; border-radius: 15px; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .rainbow-school-name {
            font-family: 'Cinzel', serif; font-size: 24px; font-weight: bold; margin-bottom: 10px; display: block;
            background: linear-gradient(to right, #ff2400, #e81d1d, #e8b71d, #1de840, #1ddde8, #2b1de8, #dd1de8, #ff2400);
            background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: rainbow_move 3s linear infinite;
        }
        @keyframes rainbow_move { to { background-position: 200% center; } }

        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); margin-top: 20px; border-top: 5px solid var(--gold); }
        
        /* Updated Input & Select Styles */
        input[type="text"], input[type="password"], select { 
            width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #eee; border-radius: 10px; 
            box-sizing: border-box; font-size: 16px; outline: none; transition: 0.3s; background: #fff;
        }
        select:focus { border-color: var(--primary); }
        
        button { padding: 15px; font-size: 16px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.3s; margin-top: 10px; }
        .btn-main { background: var(--primary); color: white; width: 100%; box-shadow: 0 4px 10px rgba(26, 42, 108, 0.3); }
        .btn-admin-access { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.4); color: white; width: auto; padding: 6px 15px; position: absolute; top: 12px; right: 12px; font-size: 12px; border-radius: 6px; }

        .question-box { margin-bottom: 30px; padding: 15px; border-radius: 12px; background: #fff; }
        .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
        .option-card { background: #f8f9fa; border: 2px solid #eaeaea; padding: 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; font-weight: 500; }
        .option-card:hover { background: #eef2ff; border-color: var(--primary); }
        .option-card input[type="radio"] { margin-right: 12px; transform: scale(1.3); }

        #timer-sticky { position: sticky; top: 0; background: #fff; padding: 15px; text-align: center; font-size: 22px; font-weight: 800; color: #b21f1f; z-index: 100; border-bottom: 3px solid var(--gold); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
    </style>
</head>
<body>

<div class="container">
    <div id="studentPage">
        <div class="header">
            <button class="btn-admin-access" onclick="toggleAdminModal()">Admin Login üîê</button>
            <span class="rainbow-school-name">‡≤∏‡≤∞‡≤ï‡≤æ‡≤∞‡≤ø ‡≤π‡≤ø‡≤∞‡≤ø‡≤Ø ‡≤™‡≥ç‡≤∞‡≤æ‡≤•‡≤Æ‡≤ø‡≤ï ‡≤∂‡≤æ‡≤≤‡≥Ü ‡≤¶‡≤æ‡≤∏‡≤∞‡≤µ‡≤æ‡≤°‡≤ø</span>
            <h1 style="margin: 5px 0; font-size: 22px;">üß† ‡≤Æ‡≤æ‡≤®‡≤∏‡≤ø‡≤ï ‡≤ó‡≤£‡≤ø‡≤§ ‡≤∏‡≥ç‡≤™‡≤∞‡≥ç‡≤ß‡≥Ü - 2025</h1>
        </div>
        <div class="card">
            <label>‡≤µ‡≤ø‡≤¶‡≥ç‡≤Ø‡≤æ‡≤∞‡≥ç‡≤•‡≤ø‡≤Ø ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å (Student Name):</label>
            <input type="text" id="sName" placeholder="Full name in English">
            
            <label>‡≤§‡≤Ç‡≤¶‡≥Ü‡≤Ø ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å (Father's Name):</label>
            <input type="text" id="pName" placeholder="Father's name">
            
            <label>‡≤§‡≤∞‡≤ó‡≤§‡≤ø (Class):</label>
            <select id="studentClass">
                <option value="">-- ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü ‡≤Æ‡≤æ‡≤°‡≤ø (Select Class) --</option>
                <option value="5">5th Class</option>
                <option value="6">6th Class</option>
                <option value="7">7th Class</option>
                <option value="8">8th Class</option>
            </select>
            
            <label id="rollLabel">‡≤∞‡≥ã‡≤≤‡≥ç ‡≤®‡≤Ç‡≤¨‡≤∞‡≥ç (Roll Number):</label>
            <input type="text" id="studentrollnumber" placeholder="Enter Roll No.">
            
            <button class="btn-main" id="startBtn" onclick="startQuiz()">‡≤ï‡≥ç‡≤µ‡≤ø‡≤ú‡≥ç ‡≤™‡≥ç‡≤∞‡≤æ‡≤∞‡≤Ç‡≤≠‡≤ø‡≤∏‡≤ø (Start Quiz) ‚ûî</button>
        </div>
    </div>

    <div id="quizPage" class="hidden">
        <div id="timer-sticky">‚è± <span id="timer">120</span> ‡≤∏‡≥Ü‡≤ï‡≥Ü‡≤Ç‡≤°‡≥Å‡≤ó‡≤≥‡≥Å</div>
        <div id="questionsContainer"></div>
        <div class="container" style="padding: 20px 0 50px 0;">
            <button class="btn-main" style="background:green;" onclick="submitQuiz()">‡≤∏‡≤≤‡≥ç‡≤≤‡≤ø‡≤∏‡≤ø (Finish Quiz)</button>
        </div>
    </div>
    

    <div id="scorePage" class="hidden">
        <div class="header">
            <span class="rainbow-school-name">‡≤∏‡≤∞‡≤ï‡≤æ‡≤∞‡≤ø ‡≤π‡≤ø‡≤∞‡≤ø‡≤Ø ‡≤™‡≥ç‡≤∞‡≤æ‡≤•‡≤Æ‡≤ø‡≤ï ‡≤∂‡≤æ‡≤≤‡≥Ü ‡≤¶‡≤æ‡≤∏‡≤∞‡≤µ‡≤æ‡≤°‡≤ø</span>
            <h1>üìä Result Leaderboard</h1>
        </div>
        <div class="card">
            <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                <button onclick="downloadWholeResultsPDF()" style="background:#e74c3c; color:white; flex:1;">Download PDF</button>
                <button onclick="exportCSV()" style="background:#1D6F42; color:white; flex:1;">Download Excel</button>
            </div>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr><th>Rank</th><th>Student</th><th>Father</th><th>Class</th><th>Roll No</th><th>Score</th><th>Action</th></tr>
                    </thead>
                    <tbody id="leaderboardBody"></tbody>
                </table>
            </div>
            <button onclick="location.reload()" style="background:#eee; color:#333; width: 100%; margin-top: 20px;">Logout / Back</button>
        </div>
    </div>

    <div id="adminModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:1000;">
        <div style="background:white; padding:30px; border-radius:15px; width:300px; text-align:center;">
            <h3>Admin Login</h3>
            <input type="password" id="adminPass" placeholder="Password">
            <button class="btn-main" onclick="verifyAdmin()">Login</button>
            <button onclick="toggleAdminModal()" style="background:none; color:gray; width:100%;">Close</button>
        </div>
    </div>
</div>

<script>
    // Firebase Config (Keep your existing config)
    const firebaseConfig = {
        apiKey: "AIzaSyCDg2lvJAsZvqP1YfalJj6jpA7qTBn5qRM",
        authDomain: "mathsquizcompetitionsjs.firebaseapp.com",
        projectId: "mathsquizcompetitionsjs",
        storageBucket: "mathsquizcompetitionsjs.firebasestorage.app",
        messagingSenderId: "697659887210",
        appId: "1:697659887210:web:21d4f2a4244093466b0413"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const questions = [
        { q: "45 + 32 = ?", options: ["77", "87", "75", "80"], a: "77" },
        { q: "100 - 37 = ?", options: ["63", "73", "53", "67"], a: "63" },
        { q: "12 √ó 5 = ?", options: ["50", "60", "70", "55"], a: "60" },
        { q: "81 √∑ 9 = ?", options: ["7", "8", "9", "10"], a: "9" },
        { q: "25 √ó 4 = ?", options: ["100", "125", "75", "150"], a: "100" },
        { q: "120 + 85 = ?", options: ["195", "205", "215", "200"], a: "205" },
        { q: "250 - 125 = ?", options: ["100", "150", "125", "115"], a: "125" },
        { q: "15 √ó 6 = ?", options: ["80", "90", "100", "75"], a: "90" },
        { q: "120 √∑ 10 = ?", options: ["10", "12", "15", "20"], a: "12" },
        { q: "99 + 11 = ?", options: ["100", "110", "111", "109"], a: "110" },
        { q: "84 - 29 = ?", options: ["55", "65", "45", "59"], a: "55" },
        { q: "9 √ó 13 = ?", options: ["107", "117", "127", "113"], a: "117" },
        { q: "100 √∑ 4 = ?", options: ["20", "25", "30", "50"], a: "25" },
        { q: "12 ‡≤∞ ‡≤µ‡≤∞‡≥ç‡≤ó (12^2) ?", options: ["124", "144", "134", "154"], a: "144" },
        { q: "25 ‡≤∞ ‡≤µ‡≤∞‡≥ç‡≤ó‡≤Æ‡≥Ç‡≤≤ (sqrt 25) ?", options: ["5", "10", "15", "25"], a: "5" },
        { q: "550 + 450 = ?", options: ["900", "1000", "1100", "950"], a: "1000" },
        { q: "500 - 199 = ?", options: ["301", "311", "299", "300"], a: "301" },
        { q: "50 √ó 20 = ?", options: ["500", "1000", "2000", "1500"], a: "1000" },
        { q: "64 √∑ 8 = ?", options: ["6", "7", "8", "9"], a: "8" },
        { q: "15 ‡≤∞ ‡≤µ‡≤∞‡≥ç‡≤ó (15^2) ?", options: ["225", "215", "205", "250"], a: "225" },
        { q: "18 + 24 + 6 = ?", options: ["42", "48", "50", "54"], a: "48" },
        { q: "1000 - 450 = ?", options: ["550", "650", "450", "500"], a: "550" },
        { q: "500 √∑ 5 = ?", options: ["50", "100", "150", "200"], a: "100" },
        { q: "81 ‡≤∞ ‡≤µ‡≤∞‡≥ç‡≤ó‡≤Æ‡≥Ç‡≤≤ (sqrt 81) ?", options: ["7", "8", "9", "11"], a: "9" },
        { q: "1 ‡≤ï‡≥Ü‡≤ú‡≤ø‡≤Ø‡≤≤‡≥ç‡≤≤‡≤ø ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å ‡≤ó‡≥ç‡≤∞‡≤æ‡≤Ç ?", options: ["100", "500", "1000", "100"], a: "1000" },
        { q: "‡≤í‡≤Ç‡≤¶‡≥Å ‡≤ó‡≤Ç‡≤ü‡≥Ü‡≤ó‡≥Ü ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å ‡≤®‡≤ø‡≤Æ‡≤ø‡≤∑ ?", options: ["30", "60", "100", "120"], a: "60" },
        { q: "20 ‡≤∞ 10% ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å ?", options: ["1", "2", "5", "10"], a: "2" },
        { q: "‡≤í‡≤Ç‡≤¶‡≥Å ‡≤°‡≤ú‡≤®‡≥ç ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å ?", options: ["10", "12", "14", "24"], a: "12" },
        { q: "7 ‡≤∞ ‡≤®‡≤Ç‡≤§‡≤∞‡≤¶ ‡≤Ö‡≤µ‡≤ø‡≤≠‡≤æ‡≤ú‡≥ç‡≤Ø ‡≤∏‡≤Ç‡≤ñ‡≥ç‡≤Ø‡≥Ü ?", options: ["8", "9", "10", "11"], a: "11" },
        { q: "100 ‡≤∞ ‡≤Ö‡≤∞‡≥ç‡≤ß‡≤¶‡≤∑‡≥ç‡≤ü‡≥Å ‡≤é‡≤∑‡≥ç‡≤ü‡≥Å ?", options: ["25", "40", "50", "60"], a: "50" }
    ];

    function toggleAdminModal() { document.getElementById('adminModal').classList.toggle('hidden'); }

    function verifyAdmin() {
        if(document.getElementById('adminPass').value === "Sairam@123") {
            toggleAdminModal();
            document.getElementById('studentPage').classList.add('hidden');
            document.getElementById('scorePage').classList.remove('hidden');
            loadLeaderboard();
        } else { alert("Wrong Password!"); }
    }

    async function startQuiz() {
        const name = document.getElementById('sName').value.trim();
        const pName = document.getElementById('pName').value.trim();
        const cls = document.getElementById('studentClass').value;
        const rollStr = document.getElementById('studentrollnumber').value.trim();
        const roll = parseInt(rollStr);

        // Basic Validation
        if(!name || !pName || !cls || !rollStr) {
            return alert("‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤é‡≤≤‡≥ç‡≤≤‡≤æ ‡≤µ‡≤ø‡≤µ‡≤∞‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤≠‡≤∞‡≥ç‡≤§‡≤ø ‡≤Æ‡≤æ‡≤°‡≤ø (Please fill all details)");
        }

        // --- CLASS WISE ROLL NUMBER VALIDATION ---
        let isValid = false;
        let limitMsg = "";

        if(cls === "5") {
            if(roll >= 1 && roll <= 27) isValid = true;
            else limitMsg = "5‡≤®‡≥á ‡≤§‡≤∞‡≤ó‡≤§‡≤ø‡≤ó‡≥Ü ‡≤∞‡≥ã‡≤≤‡≥ç ‡≤®‡≤Ç‡≤¨‡≤∞‡≥ç 1 ‡≤∞‡≤ø‡≤Ç‡≤¶ 27 ‡≤Æ‡≤æ‡≤§‡≥ç‡≤∞ ‡≤Ö‡≤µ‡≤ï‡≤æ‡≤∂‡≤µ‡≤ø‡≤¶‡≥Ü.";
        } else if(cls === "6") {
            if(roll >= 1 && roll <= 31) isValid = true;
            else limitMsg = "6‡≤®‡≥á ‡≤§‡≤∞‡≤ó‡≤§‡≤ø‡≤ó‡≥Ü ‡≤∞‡≥ã‡≤≤‡≥ç ‡≤®‡≤Ç‡≤¨‡≤∞‡≥ç 1 ‡≤∞‡≤ø‡≤Ç‡≤¶ 31 ‡≤Æ‡≤æ‡≤§‡≥ç‡≤∞ ‡≤Ö‡≤µ‡≤ï‡≤æ‡≤∂‡≤µ‡≤ø‡≤¶‡≥Ü.";
        } else if(cls === "7") {
            if(roll >= 1 && roll <= 33) isValid = true;
            else limitMsg = "7‡≤®‡≥á ‡≤§‡≤∞‡≤ó‡≤§‡≤ø‡≤ó‡≥Ü ‡≤∞‡≥ã‡≤≤‡≥ç ‡≤®‡≤Ç‡≤¨‡≤∞‡≥ç 1 ‡≤∞‡≤ø‡≤Ç‡≤¶ 33 ‡≤Æ‡≤æ‡≤§‡≥ç‡≤∞ ‡≤Ö‡≤µ‡≤ï‡≤æ‡≤∂‡≤µ‡≤ø‡≤¶‡≥Ü.";
        } else if(cls === "8") {
            if(roll >= 1 && roll <= 25) isValid = true;
            else limitMsg = "8‡≤®‡≥á ‡≤§‡≤∞‡≤ó‡≤§‡≤ø‡≤ó‡≥Ü ‡≤∞‡≥ã‡≤≤‡≥ç ‡≤®‡≤Ç‡≤¨‡≤∞‡≥ç 1 ‡≤∞‡≤ø‡≤Ç‡≤¶ 25 ‡≤Æ‡≤æ‡≤§‡≥ç‡≤∞ ‡≤Ö‡≤µ‡≤ï‡≤æ‡≤∂‡≤µ‡≤ø‡≤¶‡≥Ü.";
        }

        if(!isValid) {
            return alert(limitMsg);
        }

        // --- SINGLE ATTEMPT CHECK ---
        const btn = document.getElementById('startBtn');
        btn.innerText = "Checking...";
        btn.disabled = true;

        try {
            const check = await db.collection("mathResults")
                .where("class", "==", cls)
                .where("roll", "==", rollStr)
                .get();

            if(!check.empty) {
                alert("‡≤à ‡≤∞‡≥ã‡≤≤‡≥ç ‡≤®‡≤Ç‡≤¨‡≤∞‡≥ç ‡≤à‡≤ó‡≤æ‡≤ó‡≤≤‡≥á ‡≤ï‡≥ç‡≤µ‡≤ø‡≤ú‡≥ç ‡≤Æ‡≥Å‡≤ó‡≤ø‡≤∏‡≤ø‡≤¶‡≥Ü! (Already taken!)");
                btn.innerText = "Start Quiz ‚ûî";
                btn.disabled = false;
                return;
            }

            // Start Quiz
            const container = document.getElementById('questionsContainer');
            container.innerHTML = questions.map((item, i) => `
                <div class="card question-box">
                    <span style="font-weight:bold">${i+1}. ${item.q}</span>
                    <div class="options-grid">
                        ${item.options.map(opt => `
                            <label class="option-card">
                                <input type="radio" name="q${i}" value="${opt}"> ${opt}
                            </label>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            document.getElementById('studentPage').classList.add('hidden');
            document.getElementById('quizPage').classList.remove('hidden');
            
            let timer = 120;
            let t = setInterval(() => {
                timer--;
                document.getElementById('timer').innerText = timer;
                if(timer <= 0) { clearInterval(t); submitQuiz(); }
            }, 1000);

        } catch (e) {
            alert("Error connecting to database.");
            btn.disabled = false;
        }
    }

    async function submitQuiz() {
        let score = 0;
        questions.forEach((item, i) => {
            const sel = document.querySelector(`input[name="q${i}"]:checked`)?.value;
            if(sel === item.a) score++;
        });
        const res = {
            name: document.getElementById('sName').value,
            father: document.getElementById('pName').value,
            class: document.getElementById('studentClass').value,
            roll: document.getElementById('studentrollnumber').value,
            score: score,
            time: new Date()
        };
        await db.collection("mathResults").add(res);
        alert("‡≤ß‡≤®‡≥ç‡≤Ø‡≤µ‡≤æ‡≤¶‡≤ó‡≤≥‡≥Å! ‡≤∏‡≤≤‡≥ç‡≤≤‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü. (Submitted!)");
        location.reload();
    }

    async function loadLeaderboard() {
        const snap = await db.collection("mathResults").orderBy("score", "desc").get();
        let rank = 1;
        document.getElementById('leaderboardBody').innerHTML = snap.docs.map(doc => {
            const d = doc.data();
            return `<tr>
                <td>#${rank++}</td>
                <td>${d.name}</td>
                <td>${d.father || '-'}</td>
                <td>${d.class}th</td><td>${d.roll || '-'}</td>
                <td>${d.score}/30</td>
                <td><button onclick="deleteRecord('${doc.id}')" style="background:red; color:white; border-radius:5px; font-size:10px;">Del</button></td>
            </tr>`;
        }).join('');
    }

    async function deleteRecord(id) {
        if(confirm("Are you sure?")) {
            await db.collection("mathResults").doc(id).delete();
            loadLeaderboard();
        }
    }

    async function downloadWholeResultsPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const snap = await db.collection("mathResults").orderBy("score", "desc").get();
        const rows = snap.docs.map((d, i) => [i+1, d.data().name, d.data().father,d.data().class, d.data().roll, d.data().score + "/30"]);
        doc.text("Govt. Higher Primary School Dasarawadi,Maths Quiz Results 2025", 14, 15);
        doc.autoTable({ head: [['Rank', 'Name', 'Father', 'Class','Roll', 'Score']], body: rows, startY: 20 });
        doc.save("Results.pdf");
    }

    function exportCSV() {
        db.collection("mathResults").orderBy("score", "desc").get().then(snap => {
            let csv = "Rank,Student,Father,Class,Roll,Score\n";
            snap.docs.forEach((d, i) => {
                const s = d.data();
                csv += `${i+1},${s.name},${s.father},${s.roll},${s.class},${s.score}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'Math_Results.csv';
            a.click();
        });
    }
</script>
</body>
</html>
